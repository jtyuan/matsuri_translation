tweetToaster=function(){let t,e,n,a=!1;function l(l){performanceData.beforeSubmitTask=(new Date).getTime(),e=l;let d=$("#url");t=d.val(),dataLayer.push({event:"taskSubmit",tweetUrl:t}),t=(t=t.replace("mobile.twitter.com","twitter.com")).replace(/\?.*/,""),d.val(t);let p=$("#progress");p.val("开始获取图像"),$("#auto-progress").text("开始获取图像"),d.css("display","none"),p.css("display",""),$("#button-submit").attr("disabled","disabled"),$("#button-submit-fast").attr("disabled","disabled"),$("#translate-body").html(""),$("#screenshots").html('\n        <div id="screenshot-clip0" class="screenshot-clip"\n             style="height: 800px;background-image: url(\'img/twittersample.jpg\')">\n        </div>\n'),$.ajax({url:"/api/tasks",type:"post",data:JSON.stringify({url:t,fast:l||!1}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){!function(t){performanceData.beforeFetchImg=(new Date).getTime();let e=0,l=!1,d=$("#url"),p=$("#progress"),f=$("#auto-progress"),b=setInterval(function(){l||(l=!0,e+=1,$.ajax({url:"/api/get_task="+t,success:function(t){if(l=!1,"SUCCESS"===t.state){performanceData.getTaskSucccess=(new Date).getTime();let e=t.result.substr(0,t.result.indexOf("|")),l=t.result.substr(t.result.indexOf("|")+1);(function(t){n=t,i=[];let e=$("#translate-body");e.html("");for(let t=0;t<n.length;++t){s.hasOwnProperty(n[t].articleId)||(s[n[t].articleId]=[]),s[n[t].articleId].push(t),i.push("");let a=n[t].text||"",l=(a.match(/\n/g)||[]).length+2;a=(a=a.replace(/\n/g,"<br>")).replace(/  /g,"&nbsp; "),e.append(`\n            <tr id="translate-tr${t}">\n                <th scope="row"><input type="checkbox" ${0===t?"checked":""} id="show${t}"></th>\n                <td class="original-text">${a}</td>\n                <td>\n                <div class="translate-td" id="translate-td${t}" ${t>0?'style="display:none"':""} >\n                  <div class="input-group">\n                    <textarea id="trans-text${t}" class="form-control" ${0===t?'style="height:100px"':""} rows="${l}"></textarea>\n                  </div>\n                  <div class="dropdown template-dropdown">\n                    <button class="btn btn-outline-secondary w-100 dropdown-toggle" type="button"\n                            id="dropdown-menu${t}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n                      模板选择\n                    </button>\n                    <div class="dropdown-menu dropdown-menu-items" aria-labelledby="dropdown-menu${t}" id="dropdown-menu-items${t}"></div>\n                  </div>\n                </div>\n              </td>\n            </tr>\n`);let o=$("#trans-text"+t);o.on("focus",function(){$("#screenshot-clip"+$("tbody textarea").index(this))[0].scrollIntoView()}),o.on("keyup",function(){h(),$("#screenshot-clip"+$("tbody textarea").index(this))[0].scrollIntoView()}),o.on("change",function(){h(),$("#screenshot-clip"+$("tbody textarea").index(this))[0].scrollIntoView()}),$("#show"+t).on("change",function(){r(n[t].articleId,$(this).is(":checked")),h(),$("#screenshot-clip"+$("tbody input").index(this))[0].scrollIntoView()}),0===a.length&&0===n[t].textSize&&$("#translate-tr"+t).hide()}$(".original-text").on("click",function(){"Range"!==document.getSelection().type&&"Range"!==window.getSelection().type&&$("#show"+$(".original-text").index(this)).trigger("click")})})(l=JSON.parse(l)),h();let w=new XMLHttpRequest;w.open("GET","cache/"+e+".png"),w.onprogress=function(t){t.lengthComputable&&(p.val("正在下载图片 ("+Math.round(t.loaded/t.total*100)+"%)"),f.text("正在下载图片 ("+Math.round(t.loaded/t.total*100)+"%)"))},w.onload=function(){a&&null!=d.val().split("/")[3]&&localStorage.setItem("lastUser",d.val().split("/")[3]),a=!1,performanceData.imageLoaded=(new Date).getTime(),$("#screenshots").html('\n            <div id="screenshot-clip0" class="screenshot-clip"\n                 style="height: 800px;background-image: url(\'img/twittersample.jpg\')"></div>\n'),$("#screenshot-clip0").css("background-image",'url("cache/'+e+'.png")'),d.css("display",""),p.css("display","none"),$("#button-submit").removeAttr("disabled"),$("#button-submit-fast").removeAttr("disabled"),function(){let t,e=$("#screenshot-clip0"),a=e.css("width"),l=e.css("background-image");for(let e=0;e<n.length;++e){if((t=$("#screenshot-clip"+e)).css("height",n[e].bottom-(0===e?0:n[e-1].bottom)),t.css("display","none"),t.on("click",function(){u($(this)[0].id)}),e>0&&(t.css("background-image",l),t.css("width",a),t.css("background-position-y",-n[e-1].bottom)),e+1<n.length&&t.after('<div class="screenshot-clip" id="screenshot-clip'+(e+1)+'"></div>'),23===n[e].textSize){let t=s[n[e].articleId],a=t[t.length-1],l=$("#screenshot-clip"+a);null===localStorage.getItem("isLikeShown")||JSON.parse(localStorage.getItem("isLikeShown"))?null!=m("noLikes")&&c(l[0]):c(l[0]),l.on("click",function(){localStorage.setItem("isLikeShown",JSON.stringify(c(this)))})}else t.on("click",function(){u($(this)[0].id)});t.after('<div class="screenshot-clip" id="translate-div'+e+'"></div>'),$("#translate-div"+e).on("click",function(){u($(this)[0].id)})}}();let t=0;for(let e=0;e<l.length;e++)if(23===l[e].textSize){t=l[e].articleId;break}for(let e=0;e<l.length&&l[e].articleId<=t;++e){let t=$("#show"+e);t.is(":checked")||t.prop("checked",!0).trigger("change")}if(null!=o){let e=o.trim().match(/^##[0-9]+$/gm);if(null!=e){e=e.map(t=>+t.substr(2)-1);let n=o.trim().split(/\n?^##[0-9]+$\n?/gm).slice(1);for(let a=0;a<e.length;a++)$("#show"+e[a]).is(":checked")||$("#show"+a).prop("checked",!0).trigger("change"),$("#trans-text"+e[a]).val(n[a]),e[a]!=t&&(i[e[a]]=1)}else $("#trans-text"+t).val(o)}h(),null==o&&null==m("out")||(g(),null==m("out")&&(f.text("正在保存"),setTimeout(function(){f.text("结束")},1e3),setTimeout(function(){window.location.href="/"},3e3)))},w.send(),clearInterval(b)}},error:function(t,e,n){console.error(e),alert("服务器错误，请检查您提供的地址是否为正确的推特地址"),d.css("display",""),p.css("display","none"),$("#button-submit").removeAttr("disabled"),$("#button-submit-fast").removeAttr("disabled")},dataType:"json"}),p.val("等待服务器响应，已尝试"+e+"次"),f.text("等待服务器响应，已尝试"+e+"次"))},1e3)}(t.task_id)})}let o,s={},i=[];function r(t,e){let n=s[t];for(let t=0;t<n.length;++t){let a=$("#show"+n[t]);a.is(":checked")!==e&&a.prop("checked",e).trigger("change")}}function c(t){return $(t).hasClass("nolikes")?($(t).css("height",$(t).height()+55),$(t).removeClass("nolikes"),!0):($(t).css("height",$(t).height()-55),$(t).addClass("nolikes"),!1)}let d="",p=-1;function u(t){if(d!==t)return clearTimeout(p),d=t,void(p=setTimeout(()=>{d=""},300));t=t.replace(/[^0-9]/g,""),t=parseInt(t)}function h(){let t=$("#translate-temp-text").val(),e=$("#translate-temp-style").val(),a=!0,l=[],o=t.match(/<!--.*-->/g),s=t.split(/<!--.*-->/g);if(t&&t.length>0&&localStorage.setItem("template",t),e&&e.length>0&&($("#head-temp-style").html(e),localStorage.setItem("templateStyle",e)),o){for(let t=0;t<o.length;t++)o[t]=o[t].replace("\x3c!--","").replace("--\x3e","");for(let t=0;t<o.length/2;t++){if(o[2*t]!==o[2*t+1]){a=!1;break}l.push({name:o[2*t],content:s[2*t+1]})}}else a=!1;a?$(".translate-td").addClass("multi"):(l=[{name:"",content:t}],$(".translate-td").removeClass("multi"));let r=$(".dropdown-menu-items");r.html("");for(let t=0;t<l.length;t++)r.append('<button class="dropdown-item template-button" type="button">'+l[t].name+"</button>");$(".template-button").on("click",function(){let t=r.index($(this).parent());i[t]=$(this).text().trim(),$("#translate-div"+t)[0].scrollIntoView(),h()});for(let e=0;e<n.length;e++){let n=$("#translate-div"+e);$("#show"+e).is(":checked")?($("#screenshot-clip"+e).show(),n.show(),$("#translate-td"+e).show()):($("#screenshot-clip"+e).hide(),n.hide(),$("#translate-td"+e).hide());let o=$("#trans-text"+e);if(n.html(""),""!==o.val()){let s=o.val();s=s.replace(/https?:\/\/([^ \n]+)/g,function(t){return"<span class='link'>"+(t.replace(/https?:\/\//g,"").length>25?t.replace(/https?:\/\//g,"").substr(0,25)+"...":t.replace(/https?:\/\//g,""))+"</span>"}).replace(/(^@[^ \n]+|\n@[^ \n]+| @[^ \n]+|^#[^ \n]*[^1234567890 \n][^ \n]*|\n#[^ \n]*[^1234567890 \n][^ \n]*| #[^ \n]*[^1234567890 \n][^ \n]*)/g,"<span class='link'>$1</span>").replace(/\n/g,"<br>").replace(/  /g,"&nbsp; ");let r=t;if(a)if(r=l[0].content,"number"==typeof i[e])r=l[i[e]].content;else for(let t=0;t<l.length;t++)l[t].name===i[e]&&(r=l[t].content);n.html(twemoji.parse(r.replace("{T}",s)))}}}function m(t){let e=new RegExp("([?]|&)"+t+"=([^&]*)(&|$)"),n=window.location.href.match(e);return n?decodeURIComponent(n[2]):null}function g(){$("body")[0].scrollIntoView(),dataLayer.push({event:"downloadPNG",tweetUrl:t}),performanceData.beforeH2C=(new Date).getTime(),html2canvas(document.querySelector("#screenshots"),{useCORS:!0}).then(t=>{performanceData.afterH2C=(new Date).getTime(),null==m("out")?t.toBlob(function(t){saveAs(t,"twitterImg"+(new Date).getTime()+".png")}):($("body>*").hide(),$("body").prepend(t))})}return m("debug")&&function(t,e){let n=document.createElement("script"),a=e||function(){};n.type="text/javascript",n.readyState?n.onreadystatechange=function(){"loaded"!==n.readyState&&"complete"!==n.readyState||(n.onreadystatechange=null,a())}:n.onload=function(){a()},n.src=t,document.getElementsByTagName("head")[0].appendChild(n)}("https://cdn.bootcdn.net/ajax/libs/vConsole/3.3.4/vconsole.min.js",()=>{new VConsole}),$(function(){null!=m("template")&&m("template").length>0&&null==m("out")&&$.get(m("template"),function(t){confirm("将要用链接的内容替代现有的翻译模板，确认覆盖？")&&localStorage.setItem("template",t),window.location.href="/"});let t=$("#translate-temp");$("#btn-toggle-template").on("click",function(){"none"===t.css("display")?t.show():t.hide()}),$("#button-submit").on("click",function(){a=!0,l()}),$("#button-submit-fast").on("click",function(){a=!0,l(!0)}),localStorage.getItem("template")||localStorage.setItem("template",'<div style="margin:10px 15px">\n  <img src="img/nana_text.png" height="38">\n  <div style="font-size:24px;">{T}</div>\n</div>'),localStorage.getItem("templateStyle")||localStorage.setItem("templateStyle",".link {\n  color: #91D2FA;\n}");let e=localStorage.getItem("template"),n=localStorage.getItem("templateStyle"),s=$("#translate-temp-text"),i=$("#translate-temp-style");s.val(e),i.val(n),s.on("keyup",h),i.on("keyup",h),$(".screenshot-wrapper").on("touchstart",function(){$("body").addClass("overview")}),$(".settings-wrapper").on("touchstart",function(){$("body").removeClass("overview")}),null!=localStorage.getItem("lastUser")&&$("#url").val("https://twitter.com/"+localStorage.getItem("lastUser")),$("#url").on("keypress",function(t){"Enter"===t.key&&l(!0)}),null!=m("tweet")&&m("tweet").length>0&&(performanceData.autoBeforeTemplate=(new Date).getTime(),$.ajaxSetup({async:!1}),null!=m("template")&&m("template").length>0&&$.get(m("template"),function(t){localStorage.setItem("template",t),s.val(localStorage.getItem("template"))}),$.ajaxSetup({async:!0}),performanceData.autoAfterTemplate=(new Date).getTime(),$("#url").val(m("tweet")),null!=m("translate")&&m("translate").length>0?(o=(o=m("translate")).replace(/\\n/g,"\n"),$(".settings-container").hide(),$(".auto-banner").show()):null!=m("out")&&($(".settings-container").hide(),$(".auto-banner").show()),o&&null!=o.trim().match(/^##[0-9]+$/gm)?l(!1):l(!0))}),{downloadAsCanvas:g}}();
